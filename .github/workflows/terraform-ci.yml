# Terraform CI Workflow
#
# Purpose: Run format checking, validation, linting, testing, and optional security
# scanning for Terraform code in a single consolidated workflow.
#
# Design Decisions:
#
# 1. Single Workflow with Job Dependencies:
#    This workflow combines format, validate, lint, test, and security into a single
#    workflow file using the `needs:` keyword for job dependencies. This design
#    follows the pattern established in python-ci.yml.
#
#    Benefits of this approach:
#    - All jobs appear directly in the PR checks list (not hidden in Actions tab)
#    - Easy to configure branch protection rules that require specific jobs
#    - Later jobs don't run if earlier ones fail (saves CI minutes)
#    - Simpler maintenance with a single workflow file
#
# 2. Job Dependencies:
#    - validate needs format (don't validate poorly-formatted code)
#    - lint needs validate (don't lint invalid code)
#    - test needs validate (don't test invalid code)
#    - security needs validate (runs in parallel with lint)
#    This ensures we don't waste time on later checks if earlier ones fail.
#
# 3. Template Repository Consideration:
#    This workflow does NOT use path-based filtering because this is a template
#    repository. Path filtering would prevent the workflow from being properly tested
#    and copied by users of the template. Template repositories should run all
#    workflows on all changes to ensure accuracy when the template is used.
#
# 4. Terraform Version Policy:
#    Pin to a specific Terraform version for reproducibility. All jobs use
#    the latest stable Terraform version (1.14.4). The test framework requires
#    Terraform 1.6.0+ and mock_provider requires 1.7.0+, both satisfied by
#    the latest version. Review and update quarterly per TEMPLATE_MAINTENANCE.md.
#
# 5. TFLint Version Policy:
#    Pin to a specific TFLint version (v0.51.1) for reproducibility. Update when
#    new rules or fixes are needed.
#
# 6. Dependency Caching:
#    This workflow uses caching to improve performance:
#    - Terraform providers: Cached based on .terraform.lock.hcl hash
#    - TFLint plugins: Cached based on .tflint.hcl hash
#    Expected time savings: 30-60 seconds per CI run for provider downloads.
#
# Note: This workflow is optional. Remove if your project doesn't use Terraform.

name: Terraform CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff

  validate:
    name: Validate
    needs: format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"

      - name: Cache Terraform Providers
        uses: actions/cache@v5
        with:
          path: ~/.terraform.d/plugin-cache
          key: terraform-providers-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-providers-

      - name: Configure Provider Cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo "plugin_cache_dir = \"$HOME/.terraform.d/plugin-cache\"" > ~/.terraformrc

      - name: Find Terraform directories
        id: find-tf-dirs
        run: |
          # Find all directories containing .tf files
          TF_DIRS=$(find . -name '*.tf' -exec dirname {} \; | sort -u | tr '\n' ' ')
          echo "dirs=${TF_DIRS}" >> $GITHUB_OUTPUT

      - name: Terraform Init and Validate
        run: |
          # Validate each Terraform directory
          for dir in ${{ steps.find-tf-dirs.outputs.dirs }}; do
            echo "=== Validating $dir ==="
            cd "$dir"
            terraform init -backend=false
            terraform validate
            cd - > /dev/null
          done

  lint:
    name: Lint (TFLint)
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Cache TFLint Plugins
        uses: actions/cache@v5
        with:
          path: ~/.tflint.d/plugins
          key: tflint-plugins-${{ hashFiles('.tflint.hcl') }}
          restore-keys: |
            tflint-plugins-

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: v0.51.1

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive --config "$(pwd)/.tflint.hcl"

  test:
    name: Test
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"

      - name: Cache Terraform Providers
        uses: actions/cache@v5
        with:
          path: ~/.terraform.d/plugin-cache
          key: terraform-providers-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-providers-

      - name: Configure Provider Cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo "plugin_cache_dir = \"$HOME/.terraform.d/plugin-cache\"" > ~/.terraformrc

      - name: Check for test files
        id: check-tests
        run: |
          # Exclude templates/ directory - those are example files, not runnable tests
          if find . -path './templates' -prune -o -name '*.tftest.hcl' -print | grep -q .; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Find Terraform directories with tests
        if: steps.check-tests.outputs.has_tests == 'true'
        id: find-test-dirs
        run: |
          # Find directories containing .tftest.hcl files, excluding templates/
          TEST_DIRS=$(find . -path './templates' -prune -o -name '*.tftest.hcl' -print -exec dirname {} \; | sort -u | tr '\n' ' ')
          echo "dirs=${TEST_DIRS}" >> $GITHUB_OUTPUT

      - name: Run Terraform Tests
        if: steps.check-tests.outputs.has_tests == 'true'
        run: |
          for dir in ${{ steps.find-test-dirs.outputs.dirs }}; do
            echo "=== Testing $dir ==="
            cd "$dir"
            terraform init
            terraform test -verbose
            cd - > /dev/null
          done

      - name: Skip tests (no test files found)
        if: steps.check-tests.outputs.has_tests == 'false'
        run: echo "No Terraform test files (.tftest.hcl) found. Skipping tests."

  # Optional: Security scanning with tfsec
  # This job runs in parallel with lint (both depend on validate).
  # Set continue-on-error to true for advisory mode, false for blocking mode.
  # Uncomment to enable security scanning.
  # security:
  #   name: Security Scan
  #   needs: validate
  #   runs-on: ubuntu-latest
  #   continue-on-error: true  # Advisory mode: report findings but don't fail workflow
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v6
  #
  #     - name: Run tfsec
  #       uses: aquasecurity/tfsec-action@v1.0.3
  #       with:
  #         soft_fail: true  # Set to false to fail on findings
