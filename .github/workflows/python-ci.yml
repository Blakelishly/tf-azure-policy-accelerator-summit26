# Python CI Workflow
#
# Purpose: Run pre-commit hooks, type checking (mypy), and tests (pytest) for
# Python code in a single consolidated workflow.
#
# Design Decisions:
#
# 1. Single Workflow with Job Dependencies:
#    This workflow combines pre-commit, type checking, and tests into a single
#    workflow file using the `needs:` keyword for job dependencies. This design
#    replaces the previous pattern of separate workflow files with `workflow_run`
#    triggers.
#
#    Benefits of this approach:
#    - All jobs appear directly in the PR checks list (not hidden in Actions tab)
#    - Easy to configure branch protection rules that require specific jobs
#    - Tests don't run if pre-commit fails (saves CI minutes)
#    - Simpler maintenance with a single workflow file
#
# 2. Job Dependencies:
#    The `type-check` and `test` jobs both have `needs: pre-commit`, which means:
#    - They only run AFTER the pre-commit job completes successfully
#    - If pre-commit fails, downstream jobs are automatically skipped
#    - This ensures tests don't run on poorly-formatted code
#
# 3. Template Repository Consideration:
#    This workflow does NOT use path-based filtering (on.push.paths or
#    on.pull_request.paths) because this is a template repository. Path
#    filtering would prevent the workflow from being properly tested and
#    copied by users of the template. Template repositories should run all
#    workflows on all changes to ensure accuracy when the template is used.
#
# 4. Python Version Policy:
#    Test only actively supported bugfix versions (not security-fix-only).
#    Python versions in "security fix only" phase are NOT publicly installable
#    with security updates—they require building from source.
#    As of January 2026, Python 3.13 is the only version that qualifies.
#    Update this when upstream support changes (typically annually around October).
#    See: https://devguide.python.org/versions/
#
# 5. Dependency Caching:
#    This workflow uses caching to improve performance on cloud-hosted runners.
#    Caching reduces CI execution time by reusing previously downloaded
#    dependencies instead of re-downloading them on every run.
#
#    What is cached:
#    - pip dependencies: Cached via actions/setup-python's built-in cache
#      parameter. Cache key is based on dependency specification files.
#    - pre-commit hooks: Cached via actions/cache. Cache key is based on
#      the hash of .pre-commit-config.yaml.
#
#    Expected time savings: 60-150 seconds per CI run, depending on the
#    number of dependencies and network conditions.
#
#    Cache invalidation:
#    - pip cache invalidates when dependency specification files change
#      (e.g., pyproject.toml, requirements.txt, setup.py)
#    - pre-commit cache invalidates when .pre-commit-config.yaml changes
#
#    Note: Type checking (mypy) runs only on ubuntu-latest, not in a
#    cross-platform matrix. mypy performs platform-agnostic static analysis,
#    so cross-platform type checking would triple CI time for negligible
#    benefit. Runtime tests already cover cross-platform behavior.
#
# Note: This workflow is optional. Remove if your project doesn't use Python.

name: Python CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  pre-commit:
    name: Pre-commit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          cache: 'pip'

      # Install Terraform for pre-commit-terraform hooks (terraform_fmt, etc.)
      # This is required because the pre-commit config includes Terraform hooks
      # that need the Terraform binary to be available.
      # Version Policy: Use the latest stable Terraform version for pre-commit.
      # Review and update quarterly per TEMPLATE_MAINTENANCE.md.
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"

      - name: Cache pre-commit hooks
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

  type-check:
    name: Type Check (mypy)
    needs: pre-commit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          # Python Version Policy:
          # Always test with a Python version currently receiving bugfixes.
          # As of January 2026, Python 3.13 is the latest bugfix-supported version.
          # Update this when upstream support changes (typically annually around October).
          # See: https://devguide.python.org/versions/
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install project with dev dependencies
          # Adjust this if your project uses a different installation method
          pip install -e ".[dev]"

      - name: Run mypy
        # MYPY_PATHS Configuration:
        # Set this to the directories/files containing Python source/tests you want mypy to check.
        #
        # Examples:
        # - Flat layout (modules in root):     MYPY_PATHS="."
        # - src/ layout (recommended):         MYPY_PATHS="src/ tests/"
        # - Custom directories:                MYPY_PATHS="foo/ bar/ baz.py"
        #
        # The command-line paths override any 'files' or 'exclude' settings in
        # pyproject.toml or mypy.ini in terms of directory scope.
        env:
          MYPY_PATHS: "src/ tests/"
        run: mypy $MYPY_PATHS
        # Set continue-on-error initially; projects can make type checking strict later
        continue-on-error: true

  test:
    name: Test
    needs: pre-commit
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        # Python Version Policy:
        # Test only actively supported bugfix versions (not security-fix-only).
        # As of January 2026, Python 3.13 is the latest bugfix-supported version.
        # Python 3.12 stopped receiving bugfixes in April 2025 (security-fix-only).
        # Python versions in "security fix only" phase are NOT publicly installable
        # with security updates—they require building from source.
        # Update this when upstream support changes (typically annually around October).
        # See: https://devguide.python.org/versions/
        python-version: ['3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install project with dev dependencies
          # Adjust this if your project uses a different installation method
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest tests/ -v --cov --cov-report=term-missing

      # Codecov Integration (Optional, Commented Out)
      #
      # To enable code coverage reporting with Codecov:
      # 1. Uncomment the step below
      # 2. For public repositories: No token required
      # 3. For private repositories: Add CODECOV_TOKEN to repository secrets
      #    - Go to: https://codecov.io/ and sign in with GitHub
      #    - Find your repository and copy the token
      #    - Add to GitHub: Settings > Secrets and variables > Actions > New repository secret
      #    - Name: CODECOV_TOKEN, Value: (paste token)
      #
      # Documentation: https://docs.codecov.com/docs/github-action
      #
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}  # Required for private repos only
      #     files: ./coverage.xml
      #     flags: unittests
      #     name: codecov-umbrella
      #     fail_ci_if_error: false
