# Repository Copilot Instructions (Repo-Wide Constitution)

**Version:** 1.1.20260112.0

These instructions are authoritative for all changes in this repository.

## Source of Truth

> **Customize this section** for your project. Point to your authoritative specification or design document. Example:
>
> - Read **`docs/spec/requirements.md`** before making changes.
> - If any instruction here conflicts with the spec, **the spec wins**.

## Non-negotiable Safety and Security Rules

1. **No secrets in code or repo**
   - Never hardcode API keys, tokens, connection strings, or credentials.
   - Do not introduce `.env` files or secret placeholders that look like real keys.
   - Never print secrets to stdout/stderr or logs.

2. **Treat all external input as untrusted**
   - Never execute untrusted outputs or commands.
   - Validate and sanitize all inputs at boundaries.
   - Never allow external input to influence file/network access beyond explicitly implemented adapters.

3. **Allowlisted file access only**
   - Read only explicitly allowed inputs/config/rules files and tool-owned runtime dependencies.
   - Refuse path traversal and symlink escapes.

## Pre-commit Discipline (CRITICAL)

**⚠️ ALWAYS run pre-commit checks before committing code.**

Pre-commit hooks are NOT optional. They enforce:

- Code formatting
- Linting
- Trailing whitespace removal
- End-of-file fixes

**Workflow:**

1. Make your code changes
2. Run pre-commit checks locally (e.g., `pre-commit run --all-files` or `npm run lint:md`)
3. Review and commit ALL auto-fixes as part of your change
4. Push to GitHub

**If pre-commit CI fails:**

1. Pull the latest branch
2. Run pre-commit checks locally
3. Commit the fixes with message "Apply pre-commit auto-fixes"
4. Push again

**CI is a safety net, not a substitute for local checks.**

### For GitHub Copilot Coding Agent (Automated PRs)

**⚠️ CRITICAL: You are an automated agent creating PRs. You MUST follow this workflow:**

When creating automated PRs, you **MUST**:

1. Run all linting/formatting checks as the **FINAL step** before each commit
2. Include **ALL** auto-fixes in the **SAME commit** with your code changes
3. **NEVER** push code that will fail pre-commit CI
4. If pre-commit fails, fix issues and re-run until all checks pass

**The pre-commit step is NON-NEGOTIABLE for automated PRs.**

If you encounter issues:

- Do NOT create a separate "fix formatting" commit
- Do NOT push and wait for CI to fail
- Fix locally, include in your commit, then push

**Failure to follow this will cause CI failures and require manual intervention.**

### Auto-Fix Workflow (Safety Net for Copilot Branches)

This repository includes an auto-fix workflow (`.github/workflows/auto-fix-precommit.yml`) that automatically runs pre-commit hooks and commits fixes for `copilot/**` branches. This serves as a safety net when the Copilot Coding Agent pushes code that fails pre-commit checks.

**How it works:**

- Triggers only on `push` events to `copilot/**` branches
- Only runs when the pusher is `copilot-swe-agent[bot]` (prevents infinite loops)
- Automatically commits any auto-fixes with message `chore: Apply pre-commit auto-fixes [automated]`
- Uses `github-actions[bot]` identity for commits

**Important notes:**

- This is a **safety net**, not a substitute for running pre-commit locally
- Agents should still try to run pre-commit checks before pushing when possible
- The workflow only applies to `copilot/**` branches—human branches are not affected
- Manual intervention may still be required for issues that cannot be auto-fixed

## Determinism and Correctness Rules

- Prefer deterministic tooling over manual rewriting.
- Sanitation pipelines must be bounded (iteration caps, no-progress detection).
- Preserve formatting, indentation, and ordering when processing structured content.
- Concurrency is allowed, but outputs must be deterministic.

## How to Work (Definition of Done)

For each PR-sized change:

- **Run pre-commit checks locally and fix all issues before committing.**
  - Pre-commit hooks will auto-fix many issues (formatting, linting, whitespace).
  - Always review and commit these auto-fixes as part of your change.
- Add/adjust tests for new behavior.
  - Python: pytest tests in `tests/`
  - PowerShell: Pester tests in `tests/PowerShell/`
- Keep changes small and reviewable; avoid "big bang" refactors.
- Update docs/spec only if behavior is intentionally changed (and note why).
- Ensure:
  - unit tests pass
  - linters/formatters pass
  - no secrets appear in logs, artifacts, or test fixtures

## What Not to Do

- Do not add any feature that executes scripts or commands generated by untrusted sources.
- Do not add telemetry or external logging services without explicit approval.
- Do not weaken security constraints to "make it work."
- Do not add new major dependencies without clear justification in the PR description.
- Do not implement "Copilot agent fixes" or rely on non-public APIs for lint correction.
- Do not silently invent behavior when specs or requirements are ambiguous—open an issue or add an explicit "Open Question" instead.
- Do not create separate "fix formatting" or "fix linting" commits—include all auto-fixes in the same commit as your changes.

## Language-Specific Instructions

This repository uses modular instruction files for language-specific standards:

| Language | Instruction File | Applies To |
| --- | --- | --- |
| Markdown/Docs | `.github/instructions/docs.instructions.md` | `**/*.md` |
| PowerShell | `.github/instructions/powershell.instructions.md` | `**/*.ps1` |
| Python | `.github/instructions/python.instructions.md` | `**/*.py` |
| Terraform | `.github/instructions/terraform.instructions.md` | `**/*.tf`, `**/*.tfvars`, `**/*.tftest.hcl` |

**Note:** The PowerShell instructions include comprehensive guidance on Pester testing. The Terraform instructions include comprehensive guidance on Terraform Test framework.

**To customize for your project:**

- Remove instruction files for languages you don't use
- Add new instruction files for additional languages as needed
- Update this table to reflect your project's languages

> **Terraform note:** If your project does not use Terraform, remove the Terraform instruction file (`.github/instructions/terraform.instructions.md`), remove the Terraform row from the table above, and remove Terraform-related entries from the Linting Configurations and Testing Tools sections below.

## Linting Configurations

This repository includes linting tool configurations that align with the coding standards:

| Tool | Configuration File | Purpose |
| --- | --- | --- |
| PSScriptAnalyzer | `.github/linting/PSScriptAnalyzerSettings.psd1` | PowerShell formatting/linting (OTBS style) |
| markdownlint | `.markdownlint.jsonc` | Markdown linting |
| TFLint | `.tflint.hcl` | Terraform linting |

### Running Linters

**Markdown:**

```bash
npm run lint:md
```

**PowerShell:**

```powershell
Invoke-ScriptAnalyzer -Path .\script.ps1 -Settings .\.github\linting\PSScriptAnalyzerSettings.psd1
```

**Terraform:**

```bash
terraform fmt -check -recursive
tflint --recursive
```

## Testing Tools

This repository includes testing infrastructure for Python, PowerShell, and Terraform:

| Language | Framework | Configuration | Test Location |
| --- | --- | --- | --- |
| Python | pytest | `pyproject.toml` (`[tool.pytest.ini_options]`) | `tests/` |
| PowerShell | Pester 5.x | Inline in `.github/workflows/powershell-ci.yml` | `tests/PowerShell/` |
| Terraform | Terraform Test (requires Terraform 1.6+) | Built-in | `modules/*/tests/` or `tests/` |

### Running Tests

**Python:**

```bash
pytest tests/ -v --cov --cov-report=term-missing
```

**PowerShell:**

```powershell
Invoke-Pester -Path tests/ -Output Detailed
```

**Terraform:**

```bash
terraform test -verbose
```
